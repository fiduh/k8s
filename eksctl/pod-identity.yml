apiVersion: eksctl.io/v1alpha5
kind: ClusterConfig

metadata:
  name: basic-cluster  #Cluster name
  region: us-east-1
  version: "1.31"

# Creating Pod Identity Associations to grant permissions to AWS Load Balancer controller & API Gateway controller.
iam:
  # roleARN is not given, eksctl will first create an IAM role with automatically generated roleName,
  # using the permissionPolicy inline document
  podIdentityAssociations:
  - namespace: kube-system
    serviceAccountName: cilium-operator
    createServiceAccount: false  # Automatically create the service account if not existing
    permissionPolicy:
      Version: "2012-10-17"
      Statement:
      - Effect: Allow
        Action:
        - "ec2:CreateNetworkInterface"
        - "ec2:AttachNetworkInterface"
        - "ec2:DeleteNetworkInterface"
        - "ec2:DetachNetworkInterface"
        - "ec2:DescribeNetworkInterfaces"
        - "ec2:ModifyNetworkInterfaceAttribute"
        - "ec2:AssignPrivateIpAddresses"
        - "ec2:UnassignPrivateIpAddresses"
        - "ec2:DescribeInstanceTypes" # Required for ENI mode
        - "ec2:DescribeInstances"
        - "ec2:DescribeSubnets"
        - "ec2:DescribeVpcs"
        - "ec2:CreateTags"
        - "ec2:DescribeSecurityGroups"
        Resource: '*'

  - namespace: kube-system
    serviceAccountName: aws-load-balancer-controller
    createServiceAccount: true
    wellKnownPolicies: 
      awsLoadBalancerController: true
    permissionPolicy:
      Version: "2012-10-17"
      Statement:
      - Effect: Allow
        Action:
        - "ec2:*"
        Resource: '*'
      - Effect: Allow
        Action:
        - "elasticloadbalancing:*"
        Resource: '*'

  - namespace: kube-system 
    serviceAccountName: ack-apigatewayv2-controller
    createServiceAccount: true
    permissionPolicy:
      Version: "2012-10-17"
      Statement:
      - Effect: Allow
        Action:
        - "apigateway:*"
        Resource: 'arn:aws:apigateway:*::/*'
      - Effect: Allow
        Action:
        - "iam:CreateServiceLinkedRole"
        Resource: "*"
      